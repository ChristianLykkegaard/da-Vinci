A rotation matrix $^a_bR$ is an orthonormal matrix ($R^{-1}=R^T$) describing the rotation between two right-handed coordinate frames $\Psi_a$ and $\Psi_b$ such that any vector $^bv$ (including $\Psi_b$ coordinate axes) given in the $\Psi_b$ frame can be "rotated" into $\Psi_a$ coordinates by the operation
\begin{equation}
^av =\, ^a_bR \,\,^bv
\end{equation}
Note that the matrix $^a_bR$ can also be seen as the rotation required of the frame $\Psi_a$ for it to coincide with $\Psi_b$.
Rotation of the frame $\Psi_a$ with an angle $\theta$ counterclockwise about a single axis (equal to clockwise "rotation" of the any vector in $\Psi_b$) correspond to the rotation matrices
\begin{small}
\begin{equation}
^a_bR_x(\theta) = 
\begin{bmatrix}
1 & 0 & 0\\
0 & \cos\theta & -\sin\theta\\
0 & \sin\theta & \cos\theta
\end{bmatrix} 
\qquad
^a_bR_y(\theta) = 
\begin{bmatrix}
\cos\theta & 0 & \sin\theta \\
0 & 1 & 0\\
-\sin\theta & 0 & \cos\theta
\end{bmatrix}
\qquad
^a_bR_z(\theta) = 
\begin{bmatrix}
\cos\theta & -\sin\theta & 0\\
\sin\theta & \cos\theta & 0\\
0 & 0 & 1
\end{bmatrix}
\label{eq:RxRyRz}
\end{equation}
\end{small}
A sequence of rotations, transforming the vector $^cv$ given in the $\Psi_c$ frame to $\Psi_a$ coordinates, is implemented as
\begin{equation}
^av = \underbrace{^a_bR \,\, ^b_cR}_{^a_cR} \,\,^cv 
\end{equation}

The translation of the origin from the coordinate system $\Psi_a$ to $\Psi_b$ can be described by the position vector $^a_bp$, which is a vector given in the $\Psi_a$ coordinate frame.
The relative configuration of two coordinate frames is their relative position and orientation, which can be expressed expressed by a homogeneous matrix
\begin{equation}
^a_bH = 
\begin{bmatrix}
^a_bR & ^a_bp\\
0 & 1
\end{bmatrix}
\end{equation}
The inverse of a configuration matrix is
\begin{equation}
^a_bH^{-1} = 
\begin{bmatrix}
^a_bR^T & -^a_bR^T\,\,^a_bp\\
0 & 1
\end{bmatrix}
\end{equation}
A sequence of configurations is implemented as
\begin{equation}
^a_nH =\,\, ^a_bH \,\, ^b_cH \,\,...\,\, ^m_nH = 
\begin{bmatrix}
^a_bR \,\, ^b_cR \,\,...\,\, ^l_mR \,\,^m_nR & ^a_bp + ^a_bR \,\, ^b_cp + ... + (^a_bR\,\, ^b_cR \,\,...\,\, ^l_mR \,\, ^m_np )\\
0 & 1
\end{bmatrix}
\end{equation}
where each matrix $H$ is a function of a rotation angle $\theta$ and a translation distance, which may be functions of time.


 



\section{Robot Hand Kinematics}
The position of the end-effector (the tip of the instrument) given in an inertial frame can be described as a sequence of joint rotations of the robot and the instrument, and translation from the inertial origin via the fixed-length links and the slide of the instrument.

A coordinate frame is defined for each degree of freedom, with origin in the center of rotation. The coordinate frames of the robot hand and instrument is shown in \autoref{fig:robot_frames}, and defined in the following.

\begin{figure}[htbp]
	\hspace{-10mm}
	\subbottom[Coordinate frames for the joints on the robot "hand".]{\includegraphics[width=1.2\textwidth]{robot_coordinate_systems_new.pdf}\label{fig:robot_coordinate_systems}}%
	\vspace{1mm}
	\subbottom[The\,\,da\,\,Vinci\,\,inertial\,\,frame.]{\includegraphics[height=5.1cm]{robot_base_frame1.pdf}\label{fig:robot_base_frame}}%
	\hspace{10mm}
	\subbottom[Robot arm (grey) with inertial and robot hand base frame.]{\includegraphics[height=4.7cm]{robot_arm_with_frames.pdf}\label{fig:robot_arm_with_frames}}%
	\caption{Orientation and position of coordinate frames $\Psi_0$, $\Psi_b$, $\Psi_1$, ..., $\Psi_7$ relative to the da Vinci robot.}
	\label{fig:robot_frames}
\end{figure}

The inertial reference frame $\Psi_0$ is fixed with its origin at the robot base, as seen in \autoref{fig:robot_base_frame}. Assuming all arm joints (grey part of \autoref{fig:robot_arm_with_frames}) have zero angle, the configuration of the robot base frame (the joint of attachment between robot arm and robot hand) given in the inertial coordinates, is a pure translation along the inertial $x$- and $z$-axes:
\begin{equation}
^0_b T = \begin{bmatrix}
I & ^0_bp\\
0 & 1
\end{bmatrix}, 
\qquad\qquad\qquad
^0_bp = [^0_bp_x \quad 0 \quad ^0_bp_z]^T
\end{equation}

All rotating frames are defined such that they have rotation freedom $\theta$ about their $z$-axis, and all translating frames will translate along their $z$-axis. The rotation matrices $^a_bR$ consist of the free rotation about the $z$-axis and possibly a rotation of $\alpha=90^\circ$, to ensure that the rotation (or translation) freedom of each frame is about/along the frame's $z$-axis. The translation vectors $^a_bp$ may consist of a variable distance $d$ along the $z$-axis and a fixed distance $a$ between the frame origins.

The base link frame is rotated $\alpha=90^\circ$ about its $y$-axis to coincide with the first link frame $\Psi_1$ (see \autoref{fig:robot_coordinate_systems} and \ref{fig:robot_arm_with_frames}), and can according to \autoref{eq:RxRyRz} be expressed as
\begin{equation}
^b_1 T(\theta_1) = 
\begin{bmatrix}
R_y(\alpha) R_z(\theta_1) & 0\\
0 & 1
\end{bmatrix}
\end{equation}

The first link frame is rotated $\alpha=90^\circ$ about its $x$-axis to coincide with the second link frame $\Psi_2$ (see \autoref{fig:robot_coordinate_systems})
\begin{equation}
^1_2 T(\theta_2) = 
\begin{bmatrix}
R_x(\alpha) R_z(\theta_2) & 0\\
0 & 1
\end{bmatrix} 
\end{equation}

The second link frame is translated $a_3$ along its $y$-axis and rotated $\alpha=90^\circ$ about its $y$-axis to coincide with the instrument roll frame $\Psi_3$ (see \autoref{fig:robot_coordinate_systems})
\begin{equation}
^2_3 T(\theta_3) = 
\begin{bmatrix}
R_y(\alpha)R_z(\theta_3) & ^2_3p\\
0 & 1
\end{bmatrix}, 
\qquad\qquad\qquad
^2_3p = [0 \quad a_3 \quad 0]^T
\end{equation}

The instrument slide frame $\Psi_4$ has no rotation compared to the instrument roll frame, but includes the variable distance $d_4$ (see \autoref{fig:robot_coordinate_systems})
\begin{equation}
^3_4 T(d_4) = 
\begin{bmatrix}
I & ^3_4p\\
0 & 1
\end{bmatrix}, 
\qquad\qquad\qquad
^3_4p = [0 \quad 0 \quad d_4]^T
\end{equation}

The instrument pitch frame (wrist frame) $\Psi_5$ is obtained by rotating $\Psi_4$ by $\alpha=90^\circ$ about its $x$-axis (see \autoref{fig:robot_coordinate_systems})
\begin{equation}
^4_5 T(\theta_5) = 
\begin{bmatrix}
R_x(\alpha)R_z(\theta_5) & 0\\
0 & 1
\end{bmatrix}
\end{equation}

The instrument yaw right (gripper right) frame $\Psi_6$ is displaced $a_6$ along the $\Psi_5$ $y$-axis, and the frame is rotated $-\alpha=-90^\circ$ about the $y$-axis
\begin{equation}
^5_6 T(\theta_6) = 
\begin{bmatrix}
R_y(-\alpha)R_z(\theta_6) & ^5_6p\\
0 & 1
\end{bmatrix}, 
\qquad\qquad\qquad
^5_6p = [0 \quad a_6 \quad 0]^T
\end{equation}

Finally the instrument yaw left (gripper left) frame $\Psi_7$ is neither rotated nor translated relative to the $\Psi_6$ frame (except for the free rotation about the $z$-axis as for all other configurations)
\begin{equation}
^6_7 T(\theta_7) = 
\begin{bmatrix}
R_z(\theta_7) & 0\\
0 & 1
\end{bmatrix}
\end{equation}

The fixed distances are $a_3=530$\,mm and $a_6=14$\,mm, and the slider distance is $0\leq d_4 \leq 220$\,mm \textcolor{red}{check these and measure the $\theta$s} 


\section{Beating Heart Dynamic Model}
Illustration of heart model and description of kinematics and dynamics.
Quasi-periodic rigid 3D motion, combination of two periodic motions \cite{bib:heart_berkeley}. Frequencies assumed known from ECG and mechanical ventilator.

"The estimated components are then combined to predict future motion of the heart surface. This information, in turn, is used in the design of an explicit controller that stabilizes the relative motion of a surgical tool to a desired distance and orientation with respect to the heart surface."

"We then present a control law that uses the predicted motion to asymptotically stabilize the motion of the surgical tool to a desired distance and orientation with respect to the heart surface."

"To simplify the analysis and allow real-time prediction, we do not take the cause of the motion into consideration, and only consider the kinematics of a local area of interest on the heart surface."

"Fortunately, in this application, we have a reasonably good estimate of the phase1 and frequency of the two motion components: the respiratory phase and frequency can be obtained from the mechanical ventilator, and the cardiac phase and frequency are detected by an ECG monitor."

"choosing a convenient initial position and orientation for $\Psi_d$, e.g. such that $p^d_h(0)=0$ and $R^0_d(0) = I$

Relative configuration between heart and robot tool $H^h_r$ (with $R^h_r =[r_x, r_y, r_z]$) and error function $J(H^h_r)$
\begin{equation}
J(H^h_r) = \underbrace{\tfrac{1}{2}k_p (p^h_r-\Delta r_z)^T(p^h_r-\Delta r_z)}_\text{translational error} + \underbrace{k_x (1-e_x^T r_x) + k_y (1-e_y^T r_y) + k_z (1-e_z^T r_z)}_\text{rotational error}
\end{equation}
\begin{tabular}{rl}
	where &\\
	$\Delta$ & is the desired relative distance between the tool and the heart\\
	$E=[e_x,e_y,e_z]$ & is a rotation matrix describing the desired orientation of the tool frame\\
	$k_p,k_x,k_y,k_z$ & are constant positive parameters\\
\end{tabular}\\

Then $J$ is equal to zero (has its minimum) only when $p^h_r=\Delta r_z$ (the origin of $\Psi_r$ given in h coordinates is $\Delta$ away from the origin of $Psi_h$ along the surface normal) and $R^h_r=E$ (frame h and r axes are aligned).
\begin{align}
\dot{J} &= 
\begin{bmatrix}
k_x \hat{e}_x r_x + k_y \hat{e}_y r_y + k_z \hat{e}_z r_z\\
k_p(p^h_r - \Delta r_z)
\end{bmatrix}^T
\begin{bmatrix}
\omega^{h,h}_r \\
r^{h,h}_r
\end{bmatrix}
= (dJ)^T T^{h,h}_r\\
\dot{H}^h_r &= 
\begin{bmatrix}
\hat{\omega}^{h,h}_r r_x & \hat{\omega}^{h,h}_r r_y & \hat{\omega}^{h,h}_r r_z & \hat{\omega}^{h,h}_r p^h_r + v^{h,h}_r\\
0 & 0 & 0 & 0
\end{bmatrix}\\
(\dot{dJ}) &=
\begin{bmatrix}
-k_x \hat{e}_x \hat{r}_x  - k_y \hat{e}_y \hat{r}_y - k_z \hat{e}_z \hat{r}_z & 0\\
-k_p(\hat{p}^h_r - \Delta \hat{r}_z) & k_p I
\end{bmatrix}
T^{h,h}_r
\end{align}

"We do not consider specific robot dynamics at this point and only specify the desired inertial acceleration $\dot{T}^{0,0}_r$ of the robot end effector frame $\Psi_r$. Proposed desired acceleration"
\begin{equation}
\left(\dot{T}^{0,0}_r\right)_\text{des} = \dot{T}^{0,0}_h - \text{Ad}_{H^0_h} K_1 (\dot{dJ}) + \text{ad}_{T^{0,0}_h} T^{0,h}_r - \text{Ad}_{H^0_h} K_2 (T^{h,h}_r + K_1 dJ)
\end{equation}
\begin{tabular}{rl}
	where & \\
	$K1, K_2$ & are symmetric and positive definite matrices\\
	$H^0_h$ & is the estimated configuration of the frame $\Psi_h$ at the area of interest on the heart surface\\
	$T^{0,0}_h$ & is the estimated velocity of the frame $\Psi_h$ at the area of interest on the heart surface\\
	$\dot{T}^{0,0}_h$ & is the estimated acceleration of the frame $\Psi_h$ at the area of interest on the heart surface\\
\end{tabular}\\

This controller drives $T^{h,h}_r$ to $-K_1dJ$ by the gain $K_2$, along the steepest descend of $J$. Asymptotic stability at $J=0$, with Lyapunov function
\begin{equation}
V=\kappa_1 J + \tfrac{1}{2} (T^{h,h}_r + K_1dJ)^T K_2^{-1}(T^{h,h}_r + K_1dJ)
\end{equation}
\begin{tabular}{rl}
	where & \\
	$\kappa_1$ & is a positive constant strictly less than 4 times the smallest singular value of $K_1$, $0<\kappa_1 <4\sigma_\text{min}(K_1)$
\end{tabular}

Assuming the robot achieves perfect tracking of $\left(\dot{T}^{0,0}_r\right)_\text{des}$, the time derivative of $V$ along the system trajectories is
\begin{equation}
\dot{V} = -\left(T^{h,h}_r + (K_1 - \tfrac{\kappa_1}{2}I)dJ\right)^T \left(T^{h,h}_r + (K_1 - \tfrac{\kappa_1}{2}I)dJ\right) - \kappa_1(dJ ^T(K_1 - \tfrac{\kappa_1}{4}I)dJ
\end{equation}
\begin{tabular}{rl}
	where & \\
	$I$ & is the identity matrix\\
	$K_1 - \tfrac{\kappa_1}{4}$ & is strictly positive because of the choice of $\kappa_1$\\
\end{tabular}