Barrier certificates can be used to (in)validate the safety compliance of a controller design by testing if a barrier certificate can be found according to \autoref{eq:barrier_constraints} for the closed-loop system $f_{cl}(x)$. This can be done using Putinar's Positivstellensatz to define the spaces $\mathcal{X}$, $\mathcal{X}_u$ and $\mathcal{X}_0$ with \gls{sos} polynomials. 

A \gls{sos} polynomial $p\in \Sigma[x]$, where $\Sigma$ denotes the set of \gls{sos} variables and $[x]$ denotes a set of polynomials in $x$, is a polynomial that can be written on the form \citep{bib:sostools}
\begin{equation}
p = Z^T Q \, Z \qquad\qquad p\geq 0 \quad \forall \, x\in\mathbb{R}^n %\setminus \{0\}
\label{eq:sos_polynomial}
\end{equation}
\begin{tabular}{rl}
where &\\
$Z$ & is a monomial vector in $x\in \mathbb{R}^n$\\
$Q$ & is a real positive semidefinite symmetric coefficient matrix\\
\end{tabular}\\

A Positivstellensatz is a structure theorem of a positive polynomial on some set, and gives an algebraic certificate that a solution exists for a system of real polynomial inequalities \citep{bib:positivstellensatz}. 
%Obtain certificates of positivity on a basic semialgebraic set $\mathbb{K}\subseteq\mathbb{R}^n$. \citep{bib:sos_putinar_laurent}
%A Positivstellensatz defines the regions of a semialgebraic set where a function is positive. 
%non-commutative Positivstellens\"{a}tze characterize things like a polynomial $p$ being positive where another polynomial $q$ is positive
Specifically, the positivity (or nonnegativity or zero value) of a polynomial $h$ on a compact set $\mathbb{K}$, defined by the positivity of the polynomials $g_j$, can be expressed in terms of a weighted sum of the polynomials $g_j$ with \gls{sos} coefficients \citep[pp 184-186]{bib:sos_putinar_laurent},\citep[pp 28-29]{bib:sos_putinar_lasserre}.\\

%\textbf{Stengle's Positivstellensatz}: Given 
%\begin{align}
%\text{polynomials} \qquad & g_1,...,g_m \in \mathbb{R}[x]\\
%\text{set} \qquad & g_J\equiv\prod_{j\in J} \text{ for } J\subseteq\{1...m\}, \text{ with } g_0\equiv 1
%\end{align}
%The set 
%\begin{equation}
%T(g_1,...,g_m)\equiv\{\sum\limits_{J\subseteq \{1...m\}}^{}u_Jg_J | u_J\in\Sigma\}
%\end{equation} 
%is called a preordering on $\mathbb{R}[x]$ generated by $g_1,...,g_m$. 
%
%Theorem: for
%\begin{align}
%\text{set}	 \qquad & \mathbb{K}=\{x\in \mathbb{R}^n | g_i(x)\geq0\}, i=1...m\\
%\text{polynomial} \qquad & p\in\mathbb{R}[x]
%\end{align}
%then
%\begin{align}
%p>0 \text{ on } \mathbb{K} & \Leftrightarrow pf=1+g \text{ for some } f,g\in T(g_1,...,g_m)\\
%p\geq 0 \text{ on } \mathbb{K} & \Leftrightarrow  pf=p^{2k}+g \text{ for some } f,g\in T(g_1,...,g_m) \text{ and } k\in \mathbb{N}\\
%p=0 \text{ on } \mathbb{K} & \Leftrightarrow -p^{2k}\in T(g_1,...,g_m) \text{ for some }  k\in \mathbb{N}
%\end{align}
%\citep{bib:sos_putinar_laurent}
%
%Theorem: let $k$ be a real closed field,
%\begin{align}
%\text{polynomial} \qquad & f\in k[x]\\
%\text{set}	 \qquad & \mathbb{K}=\{x\in k^n | f_j(x)\geq0, j=1...m\}
%\end{align}
%define 
%\begin{equation}
%P(f_1,...,f_m)\equiv \{\sum\limits_{J\subseteq\{i...m\}}^{} q_Jf_J: q_J\in \Sigma[x] \}
%\end{equation}
%where $\Sigma$ denotes a \gls{sos} variable and $\Sigma[x]$ denotes a polynomial \gls{sos} variable. Then
%\begin{align}
%\text{Nichtnegativstellensatz:} \qquad\qquad\quad &\nonumber\\
%f\geq 0 \text{ on } \mathbb{K} \quad & \textup{ iff } \exists \ell \in \mathbb{N} \textup{ and } g,h\in P(f_1,...,f_m) \text{ such that } fg=f^{2\ell}+h\\
%\text{Positivstellensatz:} \qquad\qquad\quad &\nonumber\\
%f>0  \text{ on } \mathbb{K} \quad & \textup{ iff } \exists g,h\in P(f_1,...,f_m) \text{ such that } fg=1+h\\
%\text{Nullstellensatz:} \qquad\qquad\quad &\nonumber\\
%f=0 \text{ on } \mathbb{K} \quad & \textup{ iff } \exists \ell \in \mathbb{N} \textup{ and } g\in P(f_1,...,f_m) \text{ such that } f^{2\ell}+g=0
%\end{align}
%
%\citep{bib:sos_putinar_lasserre}

%\textbf{Schm\"{u}dgen's Positivstellensatz}: Given
%\begin{align}
%\text{polynomial} \qquad & p\in\mathbb{R}[x]\\
%\text{set} \qquad & \mathbb{K}=\{x\in \mathbb{R}^n | g_i(x)\geq0\}, i=1...m
%\end{align}
%then
%\begin{equation}
%p>0 \text{ on } \mathbb{K} \Rightarrow p\in T(g_1,...,g_m)
%\end{equation}
%\citep{bib:sos_putinar_laurent}
%
%Provide simple characterization of polynomial polysive on a compact basic semialgebraic set $\mathbb{K}$. Let
%\begin{equation}
%(g_j)_{j=1}^m \subset \mathbb{R}[x]
%\end{equation}
%be such that the semialgebraic set
%\begin{equation}
%\mathbb{K}\equiv\{x\in\mathbb{R}^n: g_j(x)\geq 0, j=1...m\}
%\end{equation}
%is compact. If the polynomial $f\in\mathbb{R}[x]$ is strictly positive on $\mathbb{K}$, then
%\begin{equation}
%f\in P(f_1,...,f_m)
%\end{equation}
%that is
%\begin{equation}
%f = \sum\limits_{J\subseteq\{1...m\}}^{}f_Jg_J \quad \textup{for some SOS } f_J\in\Sigma[x], \textup{ with } g_J=\prod\limits_{j\in J}^{}g_j
%\end{equation}
%\citep{bib:sos_putinar_lasserre}

%\textbf{Putinar's Positivstellensatz}: Given
%\begin{align}
%\text{polynomials} \qquad & g_1,...,g_m\in\mathbb{R}[x]\\
%\text{set} \qquad & M(g_1,...,g_m)\equiv\{u_0+\sum\limits_{j=1}^{m}u_jg_j|u_0,u_j\in\Sigma\}
%\end{align}
%the set $M(g_j)$ is called the quadratic module generated by $g_1,...,g_m$. Condition:
%\begin{equation}
%\exists f\in M(g_1,...,g_m) \textup{ s.t. } \{x\in \mathbb{R}^n|f(x)\geq 0 \}
%\end{equation}
%is a compact set, then $\mathbb{K}$ is compact since
%\begin{equation}
%\mathbb{K}\subseteq\{x|f(x\geq 0 )\} \quad \forall f\in M(g_1,...,g_m)
%\end{equation}
%The condition holds if the set $\{x\in\mathbb{R}^n|g_j(x)\geq 0 \}$. Reformulations of the condition:
%\begin{align}
%\exists N\in \mathbb{N} \quad & \textup{for which } N-\sum\limits_{i=1}^{n}x_i^2\in M(g_1,...,g_m)\\
%\forall p\in \mathbb{R}^n \exists N\in \mathbb{N} \quad & \textup{for which } N\pm p\in M(g_1,...,g_m)\\
%\exists p_1,...,p_s\in\mathbb{R}^n \quad & \textup{s.t. } p_I\in M(g_1,...,g_m) \forall I\subseteq\{1...m\} \textup{ and }\{x\in\mathbb{R}^n|p_1(x)\geq 0 ... p_s(x)\geq 0 \} \textup{ is compact}
%\end{align}
%\citep{bib:sos_putinar_laurent}
%
%Associated with the finite family $(g_j)\subset\mathbb{R}[x]$ is the subset
%\begin{equation}
%Q(g)=Q(g_1,...,g_m)\equiv \{q_0+\sum\limits_{j=1}^{m}q_jg_j: (q_j)_{j=0}^m \subset \Sigma[x] \}
%\end{equation}
%which is a convex cone called the quadratic module generated by the family $(g_j)$.
%\begin{align}
%\text{set} \qquad & \mathbb{K}\subset\mathbb{R}^n, \mathbb{K}\equiv\{x\in \mathbb{R}^n : g_j(x)\geq 0, j=1...m \} \\
%\text{polynomial} \qquad & f\in \mathbb{R}[x], f=\sum\limits_{J\subseteq \{1...m\}}^{}f_Jg_J \textup{ for some SOS } f_J\in\Sigma[x]
%\end{align}
%If $f\in\mathbb{R}[x]$ is strictly positive on $\mathbb{K}$ then $f\in Q(g)$, i.e.
%\begin{equation}
%f = f_0 + \sum\limits_{j=1}^{m}f_jg_j
%\end{equation}
%for some SOS polynomials $f_j\in\Sigma[x], J=0...m$. \citep{bib:sos_putinar_lasserre}.

\begin{exa}[Putinar's Positivstellensatz]\label{def:putinar}
Given the finite family of polynomials $(g_j)_{j=1}^m$, the subset $Q(g)$ is called the quadratic module generated by the family $(g_j)$ \citep[p 29]{bib:sos_putinar_lasserre}
\begin{subequations}\label{eq:putinar}
\begin{align}
\text{polynomials} \qquad & (g_j)_{j=1}^m \in\mathbb{R}[x]\\
\text{set} \qquad & Q(g)=Q(g_1,...,g_m)\equiv\left\{\left.q_0+\sum\limits_{j=1}^{m}q_jg_j\,\,\right| \, (q_j)_{j=0}^m\in\Sigma[x]\right\}
\end{align}
Given a polynomial $h$ and a closed basic semialgebraic set $\mathbb{K}\subset\mathbb{R}^n$ defined by the nonnegativity of the polynomials $(g_j)$  
\begin{align}
\text{polynomial} \qquad & h \in\mathbb{R}[x]\\
\text{set} \qquad & \mathbb{K}\equiv\left\{\left.x\in \mathbb{R}^n\,\, \right| \, (g_j)_{j=1}^m\geq0\right\}\qquad\qquad\qquad\qquad\qquad\quad
\end{align}
If the polynomial $h$ is strictly positive on the set $\mathbb{K}$, then $h\in Q(g)$, which means that $h$  can be formulated as
\begin{equation}\label{eq:sos_barrier}
h = q_0+\sum\limits_{j=1}^{m}q_jg_j
\end{equation}
\end{subequations}
\end{exa}


\section{Using Sums of Squares to Construct a Barrier Certificate}
%\vspace*{-7mm}
In \autoref{def:putinar} the \gls{sos} variables $q$ are nonnegative per definition and as seen from \autoref{eq:sos_barrier} $h$ is positive on $\mathbb{K}$ as defined by $g$ being positive in the region $\mathbb{K}$. Outside $\mathbb{K}$ $g$ is negative, and hence the the sign of $h$ cannot be determined outside $\mathbb{K}$.
Rearranging \autoref{eq:sos_barrier} to
\begin{equation}
q_0 = h - \sum _{j=1}^{m}q_jg_j \label{eq:putinar_sos}
\end{equation} 
however, the right-hand expression will always be nonnegative due to the SOS equality. Using the Matlab toolbox SOSTOOLS (see \autoref{app:sostools} for an introduction to the toolbox syntax), it is possible to solve for the unknown $h$ with a number of inequalities: expression $\geq 0$ on each set $\mathbb{K}$. Referring to the requirements for a barrier certificate in \autoref{def:barrier_certificate}, these inequalities can be set up as
\begin{subequations}\label{eq:barrier_constraints_putinar}
\begin{flalign}
	-B(x) &\geq 0 \kk  \forall \hspace{2mm} x \in \mathcal{X}_0 \qquad\qquad \rightarrow& 
	-B(x) - \sum _{j=1}^{m}q_jg_j &\geq 0 && \label{cer1_putinar}\\
	B(x) &> 0 \kk  \forall \hspace{2mm} x \in \mathcal{X}_u \qquad\qquad \rightarrow& 
	B(x) - \sum _{j=1}^{m}q_jg_j &\geq 0 &&\label{cer2_putinar} \\
	-L_{f_{cl}}B(x) &\geq 0 \kk  \forall \hspace{2mm} x \in \mathcal{X} \qquad\qquad\, \rightarrow& 
	-L_{f_{cl}}B(x) - \sum _{j=1}^{m}q_jg_j &\geq 0 && \label{cer3_putinar}
\end{flalign}
\end{subequations}
Note that the inequality is on positivity in \autoref{cer2} whereas it is on nonnegativity in \autoref{cer2_putinar}. This is, however, not considered an issue in the scope of this project, as the position accuracy of the robot is not on the submillimeter level. 

The problem of finding a barrier certificate $B(x)$ with the toolbox SOSTOOLS is now a matter of for each region $\mathcal{X}$, $\mathcal{X}_u$, $\mathcal{X}_0$:
\vspace*{-2mm}
\begin{itemize}
%\itemsep-1.3mm
\itemsep-0.7mm
\item Define one or more polynomials $g_j$ that are positive in the region to be defined and negative outside. Each polynomial may be solely a function of the robot tool position (and velocity) for static boundaries, and also a function of the heart position (and velocity) for dynamic boundaries.
\item Declare SOS variables $q_j$ of sufficiently large monomial degree.
\item Declare the polynomial $B(x)$ of sufficiently large monomial degree. Note that each expression in the inequalities of \autoref{eq:barrier_constraints_putinar} must have even degrees in the leading and trailing terms in order for the equality in \autoref{eq:putinar_sos} to hold.
\item Set up the inequalities according to \autoref{eq:barrier_constraints_putinar}. The inequality pertaining to a set may be defined in terms of several $g_j$; if the set is defined by $g_1 \bigcap g_2 \bigcap ... \bigcap g_m$ the inequality should be defined exactly as in \autoref{eq:putinar_sos}; however, if the set is defined by $g_1 \bigcup g_2 \bigcup ... \bigcup g_m$ the inequality must be written as several inequalities: $h - q_1g_1\geq 0$, $h - q_2g_2\geq 0$ etc.
\item Solve the \gls{sos} program. If no solution is found, increasing the degree of the \gls{sos} variables $q_j$ or the polynomial $B(x)$ may yield a solution. Otherwise it can be concluded that safety cannot be guaranteed of the closed-loop system under scrutiny.
\end{itemize}



The following chapters present the safety verification of first- and second order systems in 1D and 3D with static and dynamic boundaries. The same systems are used for the analysis as in \autoref{part:cbf}, and to the extent it is possible, also the same (pole placement design) controllers are tested. \textcolor{red}{Correct this when the chapters are written!!!}

 
	





