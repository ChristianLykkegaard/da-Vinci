Sequence of tasks for static trajecory tracking
\vspace{-3mm}
\begin{itemize}
	\itemsep-1.3mm
	\item User inputs desired final (3D) setpoint for the end-effector (in inertial frame)
	\item EITHER: The ROS OMPL computes a trajectory avoiding defined obstacles \\
	OR: $\qquad$We design an algorithm that does the path planning, based on a Lyapunov function in combination with a barrier certificate
	\item From the computed trajectory, a sequence of appropriate setpoints for the low-level controllers are generated
	\item ROS uses its inverse kinematics solvers to compute the desired state for each of the generated setpoints
	\item The low-level controllers implemented in the hardware handles the control of the setpoint tracking
\end{itemize}

Sequence of tasks for dynamic surface point tracking
\vspace{-3mm}
\begin{itemize}
	\itemsep-1.3mm
	\item User inputs desired relative position (distance and orientation) of end-effector frame with respect to the heart (surface point) frame, see \autoref{app:kinematic_model_robot} and \ref{app:dynamic_model_heart}
	\item Configuration of heart frame is computed relative to time (determine $t_0$), and from this the absolute end-effector frame is computed (real-time) - also include barrier certificates to avoid heart penetration?
	\item ROS uses its inverse kinematics solvers to compute the desired state for this configuration (real-time)
	\item The low-level controllers implemented in the hardware handles the control of the configuration tracking (real-time)
\end{itemize}

It is desired at the end of the project to perform a trajectory following task with the robot arm (not only simulations or visualization through the ROS tool Rviz), and for that a tissue phantom must be procured, which allows for multiple tests with cutting tools.

\section{Safety Precautions for Automated Surgery Control}\label{sec:safety-def}
A crucial matter when dealing with those topics within robotic surgeries feature necessary conditions to guarantee the patient safety and to avert patient trauma \citep{bib:safety}.




The system considered will be the general non-linear system on the form:
\begin{flalign*}
\dot{x} = f(x) + g(x)\,u + h(x)\,d
\end{flalign*}
\vspace{-0.7cm}
\begin{longtable}{p{.9\textwidth} p{.1\textwidth} p{.1\textwidth}} 
where & & \\
\gls{x} is the state and restricted to $x \in \mathbb{R}^n$ where  \gls{n} is the number of states &[$\cdot$]& \\
\gls{u} is the control input and restricted to $u \in \mathbb{R}^m$ where \gls{m} is the number of inputs& [$\cdot$]& \\
\gls{d} is the disturbance input and restricted to $d \in D \subseteq \mathbb{R}^p$ where \gls{p} is the number of disturbances & [$\cdot$]& \\
\gls{f} is a potential non-linear function, $f:\mathbb{R}^n \rightarrow \mathbb{R}^n$ & [$\cdot$]& \\
\gls{g} is a potential non-linear function, $g:\mathbb{R}^n \rightarrow \mathbb{R}^{n \times m}$ & [$\cdot$]& \\
\gls{h} is a potential non-linear function, $h:\mathbb{R}^n \rightarrow \mathbb{R}^{n \times p}$ & [$\cdot$]& 
\end{longtable}

The definition of safety will follow the definition described in \citep{bib:safety}, i.e.:
\begin{exa}
A closed loop control system, $\Gamma_\text{cl} = (f_\text{cl},h,X,X_0.X_u,D)$, is unsafe if there exist a time $t \in [0,$\gls{T}$]$ such that the trajectory $\phi_{X_0}^{\bar{d}} : [0,T]$ satisfy: 
	\begin{flalign}
		\left( \phi_{X_0}^{\bar{d}}([0,t]) \cap X_u \right) \neq \emptyset \kk \wedge \kk 
		\phi_{X_0}^{\bar{d}}([0,t]) \subseteq X
	\label{eq:defsafety}
	\end{flalign}
The closed loop system $\Gamma_\text{cl}$ is safe if there are no unsafe trajectories.
\vspace{-0.2cm}
\begin{longtable}{p{.9\textwidth} p{.1\textwidth} p{.1\textwidth}} 
Where  & & \\
\gls{fcl} is a potential non-linear function with the closed loop characteristic:\\ \kk $f_\text{cl}: x \mapsto f(x)+g(x)k(x)$ where \gls{k} is the feedback gain with the map $k: \mathbb{R}^n \rightarrow \mathbb{R}^m$ & [$\cdot$] &  \\
\gls{X} is the set of all allowed states & [$\cdot$] &  \\
\gls{X0} is the set of all allowed initial states & [$\cdot$] &  \\
\gls{Xu} is the set of all unsafe states & [$\cdot$] &  \\
\gls{phi} is the set of all allowed initial conditions with the bounded disturbance input \gls{dbar} & [$\cdot$]
\end{longtable}
A graphical interpretation can be deduced from \autoref{eq:defsafety} and found in \autoref{fig:defsafety}.
\begin{figure}[H]
	\center
		\includegraphics[width=0.75\textwidth]{safety.pdf}	
	\caption{Graphically interpretation of \autoref{eq:defsafety} in the state space. The blue trajectory is unsafe while the green trajectory is safe.}
	\label{fig:defsafety}
\end{figure}
\label{def_safety}
\end{exa}

\textbf{Beskriv forskellige m\aa der at h\aa ndtere constraint, samt beskriv deres fordele og ulemper!}

- \gls{mpc} \\
- \gls{clf} combined wiht \gls{cbf} (stabilization property of CLF
with the safety aspect from the CBF)   \\
- reference governor?\\

\gls{lie}

If the system always moves very slowly, acceleration may be ignored and maybe dyamics could be ignored altogether, only leaving the evolution of kinematics in the function $f(x)$.

The design of a safe controller features the property that a supplied control signal ensures compliance of the definition described in \autoref{sec:safety-def}.

A one-dimensional simple case is analysed at first. The approach adopted constitute the movement of instrument slide, see \autoref{fig:lol}.

\begin{figure}[H]
\center
--- NICE FIGURE OF INSTRUMENT SLIDE ---
\caption{nice figure}
\label{fig:lol}
\end{figure}

A barrier certificate function can be constructed from the definitions, i.e.:
\begin{flalign}
& B(x) \leq 0 \kk  \forall \hspace{0.3cm} x \in \mathcal{X}_0  \label{cer1}\\
& B(x) > 0  \kk  \forall \hspace{0.3cm} x \in \mathcal{X}_u \label{cer2} \\
& L_f(B(x)) \leq 0 \kk  \forall \hspace{0.3cm} x \in \mathcal{X} \label{cer3}
\end{flalign}
\vspace{-0.8cm}
\begin{longtable}{p{.9\textwidth} p{.1\textwidth} p{.1\textwidth}} 
Where  & & \\
\gls{bar} is the barrier function & [$\cdot$] \\ 
\end{longtable}
\vspace*{-0.2cm}
Based on \citep{bib:artstein}, which founded \gls{clf}s, a \gls{cbf} can be created \citep{bib:org_control}. With a system $\dot{x}=f(x)+g(x)u$, a \gls{cbf} exist if the below constraints are fulfilled:
\begin{flalign}
& x\in \mathcal{X}_u \hspace{0.3cm} \Rightarrow \hspace{0.3cm} B(x) > 0  \label{req1} \\
& L_gB(x) = 0 \hspace{0.3cm} \Rightarrow \hspace{0.3cm} L_fB(x) < 0 \label{req2} \\
& \{ x \in \mathcal{X} | B(x) \leq 0 \} \neq \emptyset \label{req3}
\end{flalign}
\vspace{-0.8cm}
\begin{longtable}{p{.9\textwidth} p{.1\textwidth} p{.1\textwidth}} 
Where  & & \\
$L_f(x)$ is the Lie derivative of $B(x)$ along the vector field  $f(x)$, i.e. $\frac{\partial B(x)}{\partial x}f(x)$ & [$\cdot$] \\ 
$L_f(x)$ is the Lie derivative of $B(x)$ along the vector field  $g(x)$, i.e. $\frac{\partial B(x)}{\partial x}g(x)$ & [$\cdot$] 
\end{longtable}
\vspace*{-0.2cm}
Taking a look at \autoref{req1} it states essentially the same as \autoref{cer2}, i.e. the unsafe area exist whenever $B(x)>0$. This makes it possible to design a unsafe region. \Autoref{req2} put forth the requirement that the gradient along the vector field $f(x)$ must point away from the barrier extremities whenever the input is with no significance (except for the critical point). \Autoref{req3} simply states that the safe area must contain some states as control otherwise is impossible.
\section{1-Dimensional Controller Design for Safety}
The slide movement is visualized in \autoref{fig:slidefig} and an overview of terms used in this section is found in \autoref{fig:safe:overview}.
\begin{figure}[!htb]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{slidemovefigure.pdf}
        \caption{Illustration of slide movement.}
        \label{fig:slidefig}
    \end{minipage}%
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.48\linewidth]{slide_overview.pdf}
        \caption{Case study.}
        \label{fig:safe:overview}
    \end{minipage}
\end{figure}

To obtain a model, a step response will be performed on the slide movement. The slide position can be measured by publishing the joint state angle in \gls{ros}. The experiment is described in further details in \autoref{app:meas}.

%\hspace{1cm }\texttt{rostopic echo joint\_states/position[6]} \hspace{0.2cm} {\color{blue}{\# Be sure to have the ROS environment correctly configured according to \autoref{app:ros}}}
\subsubsection{Modelling of Slide Movement}
To model the system, a step is added to the system. The step response is plotted in \autoref{fig:stepresponseslide}. Measurement log is found in \autoref{app:meas}.
\begin{figure}[H]
\center
\includegraphics[scale=0.5]{step_slide.eps}
\caption{Step response from 0\,mm to 5\,mm. Plot details and measurements can be found in \autoref{app:cd} as \texttt{matlab\_scripts/slide\_step/plot\_slide\_pos.m}}
\label{fig:stepresponseslide}
\end{figure}
It is clear that this could be well approximated with an underdamped second order model (complex roots), however for initial simplicity and because modelling is not a focus point in this thesis, merely a simple model of the slide movement is used (it shall later be approximated to a second order model). Therefore, with some good will, it is approximated to a linear first order system with a dominating time constant \gls{taus}: 
\begin{flalign*}
& Y(s) = \dfrac{1}{\tau_s s + 1}U(s) =  \dfrac{1/\tau_s}{s + 1/\tau_s}\,U(s) = (s+1/\tau_s)^{-1}\,1/\tau_s\,U(s) \kk  \overset{\overset{Y(s)=(C(sI-A)^{-1}B+D)U(s)}{\longrightarrow}}{\scriptsize \text{compare to obtain SS form}}  \\ 
& \dot{x} = \underbrace{-\tau_s^{-1}\,x}_{f_s(x)} + \underbrace{\tau_s^{-1}}_{g_s(x)} u
\end{flalign*}
Thus the system matrix $A$ and the input matrix $B$ can be seen easily. For the sake of generalization, they are named $f_s$ and $g_s$, i.e.:
\begin{flalign*}
f_s(x) = -\tau^{-1}x \kk \wedge \kk g_s(x) = \tau_s^{-1}
\end{flalign*}
A suitable time constant $\tau_s$ can be read from \autoref{fig:stepresponseslide} to:
\begin{flalign*}
\tau_s = 55\, \text{ms}
\end{flalign*} 
\subsubsection{Construction of CBF}
To illustrate the usefulness of \gls{cbf}s, a palpable example hereof will be created with direct application to the Da Vinci robot. This example does not directly constitute application to a patient but favour the theory in a neat and comprehensible sense and secure a way to visually and physically verify the method.

Consider the state intervals defined in \autoref{tab:intervals}.
\begin{table}[H]
	\begin{tabularx}{\textwidth}{X X X X X}
\rowcolor{HeaderBlue} 
$\mathcal{X}_G$ & $\mathcal{X}_S$  & $\mathcal{X}_u$ & $\bar{\mathcal{X}}_u$ & $\mathcal{X}_0$ \\
$x \in [-\Psi_\text{lim}:\Psi_\text{lim}]$ & $x \in [\Psi_s:\Psi_\text{lim}]$  & $x \in [\Psi_h:\Psi_\text{lim}] $ & $ x \in [-\Psi_\text{lim}:\Psi_h] $ & $x \in [-\Psi_\text{lim}:\Psi_h]$  \\
\end{tabularx}
\caption{Global state intervals where: $\Psi_\text{lim}$ is the physical slide limit ($\pm$0.1\,m), $\Psi_s$ is a soft limit denoting a transition area and $\Psi_h$ is a hard limit where a trajectory at all cost can not cross.}
\label{tab:intervals}
\end{table}
A parabola is now introduced as \gls{cbf}. A coordinate shift is performed such that the slide movement occurs along the $x$-axis instead of the $z$-axis. 
\begin{flalign*}
B(x) = ax^2+bx+c \kk \Rightarrow \kk L_fB(x) = \dfrac{d}{dx}B(x)f_s(x) = (2ax+b)(-\tau^{-1}x) = -2\tau^{-1}ax^2-\tau^{-1}bx
\end{flalign*}
\Autoref{req2} put forth the demand that $L_fB(x)<0$ when $L_gB(x) = 0$ as the input in that case will be insignificant. Ensuring that $L_fB(x)<0$ in the area $x \in [\Psi_s:\Psi_h]$ is therefore indeed sufficient. Analysis of $L_fB(x)$ shall reveal when $L_fB(x)>0$, i.e. to ensure the demand below:
\begin{flalign*}
L_fB(x) \ngtr 0\hspace{0.3cm}\forall\hspace{0.3cm} x \in [\Psi_s:\Psi_h]
\end{flalign*}
Thus the analysis is performed:
\begin{flalign}
L_fB(x) < 0 \kk \Leftrightarrow \kk -2\tau^{-1}ax^2-\tau^{-1}bx < 0
\label{eq:analysis}
\end{flalign}
The coefficients $a$ and $b$ must be found. By studying $x>0$ it can from \autoref{eq:analysis} be seen that:
\begin{flalign*}
\forall \mm \{ a > 0 \mm  \wedge \mm b > 0 \} \mm \Rightarrow \mm L_fB(x) < 0 \mm \forall \mm  x > 0
\end{flalign*}
The scenario changes when $x<0$. Preserving that $a>0$ and $b>0$, the analysis below put forth constraints to the x.
\begin{flalign}
&L_fB(x) = 0 \kk \Leftrightarrow \kk  -2\tau^{-1}ax^2-\tau^{-1}bx = 0 \nonumber
 \\  &-2ax^2-bx = 0 \mm \Rightarrow \mm x = 
\begin{cases}
  \frac{-b}{2a} \\
   0,             
\end{cases}
\label{eq:interval1}
\end{flalign}
Thus, $B(x)$ is not a valid barrier function within the interval:
\begin{flalign}
B(x) \hspace{0.15cm} \text{invalid:} \mm  x \in \left[ \frac{-b}{2a}:0 \right] \mm \text{if} \mm L_gB(x) = 0
\label{eq:interval}
\end{flalign}
Three equations with three unknowns can be outlined to fulfil the initial demand in figure ??.
\begin{flalign*}
 \left.
 \begin{aligned}
a\,\Psi_h^2 + b\,\Psi_h + c = 0 \\
a\,(-\Psi_\text{lim})^2 + b\,(-\Psi_\text{lim})^2 + c = 0 \\
a\left( \frac{-\Psi_\text{lim}+\Psi_h}{2}\right)x^2 + b\left(\frac{-\Psi_\text{lim}+\Psi_h}{2}\right) + c = - 0.025 
\end{aligned}
\mm \right\}
 \qquad \begin{matrix}
 a &= \,\,\,\,\,\,\,\,1.7778 \\ b &= \,\,\,\,\,\,\,\,0.0889 \\ c &= -0.0089
 \end{matrix}
\end{flalign*}
The interval where $B(x)$ is invalid can thereby be found from \autoref{eq:interval}:
\begin{flalign*}
B(x) \hspace{0.15cm} \text{invalid:} \mm  x \in [-0.0250:0]
\end{flalign*}
This is indifferent as $\mathcal{X}_S  \notin [-\Psi_\text{lim}+d_t:\Psi_s]$. Thus the barrier function is plotted in \autoref{fig:barrierfunction}
\begin{figure}[H]
\center
\includegraphics[scale=0.5]{parabel_1.eps}
\caption{Barrier function along with the $\mathcal{X}_u$ and $\bar{\mathcal{X}_u}$. Plot details and MATLAB script can be found in ????}
\label{fig:barrierfunction}
\end{figure}


\newpage
\subsection{Controller Design}
As indicated, the controller designed for safety $k_0$ does not necessarily have to be active before the slide position is within some distance $d_t$ (determined by a parameter $\epsilon$) of a hard boundary $\Psi_h$. This crossing line shall be denoted as a soft boundary $\Psi_s$. See ??? for an overview of these parameters. This does indeed suggest for a divided control law \citep{bib:org_control}. Consider the control law below:
\begin{flalign*}
u(x) = \sigma(x)k_0(x)+(1-\sigma(x))\tilde{u}(x) = \sigma(x)k_0(x)+(1-\sigma(x))(\bar{N} \cdot x_\text{ref}-Kx) 
\end{flalign*}
\vspace{-0.8cm}
\begin{longtable}{p{.9\textwidth} p{.1\textwidth} p{.1\textwidth}} 
Where  & & \\
$u(x)$ is a control signal where safety is ensured  & [$\cdot$] \\
$\tilde{u}(x)$ is a control signal to the linear state space system such that $\tilde{u}=\bar{N}\cdot x_\text{ref}-Kx$ & [$\cdot$] \\ 
$k_0(x)$ is a control law that guarantees safety & [$\cdot$] \\ 
$\sigma(x)$ is a parameter that founds a linear combination of the two controllers & [$\cdot$] 
\end{longtable}
\vspace*{-0.2cm}
The system performs a pure textbook example of a linear state space controller when $\sigma(x) = 0$, thus no safety aspects are considered as the system is within the boundary $\Psi_s$. When $\sigma(x) = 1$ the trajectory has had direct impact with the hard boundary $\Psi_h$ and the system performs with a 100\,\% dedication to $k_0$. This causes the trajectory to oppose its current target and redirect to a safe place in the state space.

\begin{figure}[H]
	\center
		\includegraphics[scale=1]{control_system.pdf}
	\caption{nice figure}
	\label{fig:controlsystem}
\end{figure}




